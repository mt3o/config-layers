(function(c,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(c=typeof globalThis<"u"?globalThis:c||self,f(c["Config Layers"]={}))})(this,(function(c){"use strict";function f(a){return typeof a=="string"}function p(a){return a.split(new RegExp("(?<!\\.)\\.(?!\\.)"))}function y(a,r){for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&typeof r[t]=="object"&&r[t]!==null&&!Array.isArray(r[t])?(t in a||(a[t]={}),y(a[t],r[t])):a[t]=r[t];return a}function h(a){return a&&typeof a=="object"&&!Object.isFrozen(a)&&(Object.getOwnPropertyNames(a).forEach(r=>{const t=a[r];t&&typeof t=="object"&&h(t)}),Object.freeze(a)),a}class d{layers;flattened;constructor(r,t=void 0){this.layers=r,this.flattened=Array.from(this.layers.values()).reduce((s,i)=>y(s,i),{}),this.options={notFoundHandler:s=>{throw new Error(`Key not found: ${String(s)}`)},freeze:!0,...t??{}}}options;static fromLayers(r,t){const s=new d(new Map(r.map(i=>[i.name,i.config])),t);return h(s),new Proxy(()=>{},{apply(i,e,n){const[o,l]=n;return s.__withFallback(o,l)},has(i,e){const n=f(e)?p(e):[e];return n.length==1?s.__getFlat(e)!==void 0:n.length>1?s.__getComplex(e)!==void 0:!1},getOwnPropertyDescriptor(i,e){return{enumerable:!0,configurable:!0}},deleteProperty(i,e){return!1},set(){return!1},defineProperty(){return!1},ownKeys(){const e=Array.from(s.layers.values()).map(o=>Object.keys(o)),n=Array.from(new Set(e.flat()));return{...n,length:n.length}},get(i,e,n){if(e==="__inspect")return s.__inspect.bind(s);if(e==="__derive")return s.__derive.bind(s);const o=f(e)?p(e):[e];if(o.length==1)return s.__getFlat(e);if(o.length>1)return s.__getComplex(e)}})}__withFallback(r,t){return(f(r)?p(r):[r]).length==1?this.__getFlat(r,t):this.__getComplex(r,t)}__derive(r,t,s){const i=Array.from(this.layers.entries()).reduce((e,[n,o])=>(e[n]=o,e),{});if(typeof r=="object"&&t===void 0){const e=Object.assign({},this.options,r);return d.fromLayers(Object.entries(i).map(([n,o])=>({name:n,config:o})),e)}return typeof r=="string"&&t!==void 0?(i[r]=t,d.fromLayers(Object.entries(i).map(([e,n])=>({name:e,config:n})),Object.assign({},this.options,s??{}))):d.fromLayers(Object.entries(i).map(([e,n])=>({name:e,config:n})),Object.assign({},this.options,s??{}))}__getComplex(r,t){const s=f(r)?p(r):[r],i=Array.from(this.layers.values()).reverse();let e={},n;for(const o of i){if(!o)continue;let l=o,u=!0;for(const v of s)if(l&&v in l)l=l[v];else{u=!1;break}if(u&&typeof l!="object"){n=l;break}else u&&typeof l=="object"&&(n=void 0,e={...e,...l})}return n!==void 0?n:Object.keys(e).length>0?e:t||this.options.notFoundHandler(r)}__getFlat(r,t){const s=this.flattened[r];return s!==void 0?s:t||this.options.notFoundHandler(r)}__inspect(r){const t={key:r,resolved:{value:void 0,source:""},layers:[]},s=f(r)?p(r):[r],i=Array.from(this.layers.keys()).reverse();if(s.length<1)return{key:r,resolved:{value:void 0,source:""},layers:i.map(e=>({layer:e,value:void 0,isPresent:!1,isActive:!1}))};if(s.length==1){let e=!1;for(const n of i){const o=this.layers.get(n),l=!!(o&&r in o),u=l?o?.[r]:void 0,v=l?!e:!1;t.layers.push({layer:n,value:l?u:void 0,isPresent:l,isActive:v}),v&&!e&&(t.resolved.value=u,t.resolved.source=n,e=!0)}}if(s.length>1)for(const e of i){let n=this.layers.get(e);if(!n)continue;let o=!0;for(const u of s)if(n&&typeof n=="object"&&u in n)n=n[u];else{o=!1;break}o||(n=void 0);const l=o&&n!==void 0;t.layers.push({layer:e,value:l?n:void 0,isPresent:o,isActive:l&&t.resolved.value===void 0}),l&&t.resolved.value===void 0&&(t.resolved.value=n,t.resolved.source=e)}return t}}c.LayeredConfig=d,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})}));
