(function(f,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(f=typeof globalThis<"u"?globalThis:f||self,u(f["Config Layers"]={}))})(this,(function(f){"use strict";function u(a){return typeof a=="string"}function d(a){return a.split(new RegExp("(?<!\\.)\\.(?!\\.)")).map(e=>e.replace(/([^,])\.([.]+[^,])/gu,"$1$2"))}function y(a,e){for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&typeof e[t]=="object"&&e[t]!==null&&!Array.isArray(e[t])?(t in a||(a[t]={}),y(a[t],e[t])):a[t]=e[t];return a}function h(a){return a&&typeof a=="object"&&!Object.isFrozen(a)&&(Object.getOwnPropertyNames(a).forEach(e=>{const t=a[e];t&&typeof t=="object"&&h(t)}),Object.freeze(a)),a}class p{layers;flattened;constructor(e,t=void 0){this.layers=e,this.flattened=Array.from(this.layers.values()).reduce((s,i)=>y(s,i),{}),this.options={notFoundHandler:s=>{throw new Error(`Key not found: ${String(s)}`)},freeze:!0,...t??{}}}options;static fromLayers(e,t){const s=new p(new Map(e.map(i=>[i.name,i.config])),t);return s.options.freeze&&h(s),new Proxy(()=>{},{apply(i,r,n){const[o,l]=n;return s.__withFallback(o,l)},has(i,r){const n=u(r)?d(r):[r];return n.length==1?s.__getFlat(n[0])!==void 0:n.length>1?s.__getComplex(r)!==void 0:!1},getOwnPropertyDescriptor(i,r){return{enumerable:!0,configurable:!0}},deleteProperty(i,r){return!1},set(){return!1},defineProperty(){return!1},ownKeys(){const r=Array.from(s.layers.values()).map(o=>Object.keys(o)),n=Array.from(new Set(r.flat()));return{...n,length:n.length}},get(i,r,n){if(r==="__inspect")return s.__inspect.bind(s);if(r==="__derive")return s.__derive.bind(s);const o=u(r)?d(r):[r];if(o.length==1)return s.__getFlat(o[0]);if(o.length>1)return s.__getComplex(r)}})}__withFallback(e,t){const s=u(e)?d(e):[e];return s.length==1?this.__getFlat(s[0],t):this.__getComplex(e,t)}__derive(e,t,s){const i=Array.from(this.layers.entries()).reduce((r,[n,o])=>(r[n]=o,r),{});if(typeof e=="object"&&t===void 0){const r=Object.assign({},this.options,e);return p.fromLayers(Object.entries(i).map(([n,o])=>({name:n,config:o})),r)}return typeof e=="string"&&t!==void 0?(i[e]=t,p.fromLayers(Object.entries(i).map(([r,n])=>({name:r,config:n})),Object.assign({},this.options,s??{}))):p.fromLayers(Object.entries(i).map(([r,n])=>({name:r,config:n})),Object.assign({},this.options,s??{}))}__getComplex(e,t){const s=u(e)?d(e):[e],i=Array.from(this.layers.values()).reverse();let r={},n;for(const o of i){if(!o)continue;let l=o,c=!0;for(const v of s)if(l&&v in l)l=l[v];else{c=!1;break}if(c&&typeof l!="object"){n=l;break}else c&&typeof l=="object"&&(n=void 0,r={...r,...l})}return n!==void 0?n:Object.keys(r).length>0?r:t||this.options.notFoundHandler(e)}__getFlat(e,t){const s=this.flattened[e];return s!==void 0?s:t||this.options.notFoundHandler(e)}__inspect(e){const t={key:e,resolved:{value:void 0,source:""},layers:[]},s=u(e)?d(e):[e],i=Array.from(this.layers.keys()).reverse();if(s.length<1)return{key:e,resolved:{value:void 0,source:""},layers:i.map(r=>({layer:r,value:void 0,isPresent:!1,isActive:!1}))};if(s.length==1){let r=!1;for(const n of i){const o=this.layers.get(n),l=!!(o&&e in o),c=l?o?.[e]:void 0,v=l?!r:!1;t.layers.push({layer:n,value:l?c:void 0,isPresent:l,isActive:v}),v&&!r&&(t.resolved.value=c,t.resolved.source=n,r=!0)}}if(s.length>1)for(const r of i){let n=this.layers.get(r);if(!n)continue;let o=!0;for(const c of s)if(n&&typeof n=="object"&&c in n)n=n[c];else{o=!1;break}o||(n=void 0);const l=o&&n!==void 0;t.layers.push({layer:r,value:l?n:void 0,isPresent:o,isActive:l&&t.resolved.value===void 0}),l&&t.resolved.value===void 0&&(t.resolved.value=n,t.resolved.source=r)}return t}}f.LayeredConfig=p,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})}));
