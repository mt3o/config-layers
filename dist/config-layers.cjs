"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function p(a){return typeof a=="string"}function d(a){return a.split(new RegExp("(?<!\\.)\\.(?!\\.)")).map(e=>e.replace(/([^,])\.([.]+[^,])/gu,"$1$2"))}function v(a,e){for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&typeof e[t]=="object"&&e[t]!==null&&!Array.isArray(e[t])?(t in a||(a[t]={}),v(a[t],e[t])):a[t]=e[t];return a}function y(a){return a&&typeof a=="object"&&!Object.isFrozen(a)&&(Object.getOwnPropertyNames(a).forEach(e=>{const t=a[e];t&&typeof t=="object"&&y(t)}),Object.freeze(a)),a}class u{layers;flattened;constructor(e,t=void 0){this.layers=e,this.flattened=Array.from(this.layers.values()).reduce((n,i)=>v(n,i),{}),this.options={notFoundHandler:n=>{throw new Error(`Key not found: ${String(n)}`)},freeze:!0,...t??{}}}options;static fromLayers(e,t){const n=new u(new Map(e.map(i=>[i.name,i.config])),t);return n.options.freeze&&y(n),new Proxy(()=>{},{apply(i,r,s){const[o,l]=s;return n.__withFallback(o,l)},has(i,r){const s=p(r)?d(r):[r];return s.length==1?n.__getFlat(s[0])!==void 0:s.length>1?n.__getComplex(r)!==void 0:!1},getOwnPropertyDescriptor(i,r){return{enumerable:!0,configurable:!0}},deleteProperty(i,r){return!1},set(){return!1},defineProperty(){return!1},ownKeys(){const r=Array.from(n.layers.values()).map(o=>Object.keys(o)),s=Array.from(new Set(r.flat()));return{...s,length:s.length}},get(i,r,s){if(r==="__inspect")return n.__inspect.bind(n);if(r==="__derive")return n.__derive.bind(n);const o=p(r)?d(r):[r];if(o.length==1)return n.__getFlat(o[0]);if(o.length>1)return n.__getComplex(r)}})}__withFallback(e,t){const n=p(e)?d(e):[e];return n.length==1?this.__getFlat(n[0],t):this.__getComplex(e,t)}__derive(e,t,n){const i=Array.from(this.layers.entries()).reduce((r,[s,o])=>(r[s]=o,r),{});if(typeof e=="object"&&t===void 0){const r=Object.assign({},this.options,e);return u.fromLayers(Object.entries(i).map(([s,o])=>({name:s,config:o})),r)}return typeof e=="string"&&t!==void 0?(i[e]=t,u.fromLayers(Object.entries(i).map(([r,s])=>({name:r,config:s})),Object.assign({},this.options,n??{}))):u.fromLayers(Object.entries(i).map(([r,s])=>({name:r,config:s})),Object.assign({},this.options,n??{}))}__getComplex(e,t){const n=p(e)?d(e):[e],i=Array.from(this.layers.values()).reverse();let r={},s;for(const o of i){if(!o)continue;let l=o,c=!0;for(const f of n)if(l&&f in l)l=l[f];else{c=!1;break}if(c&&typeof l!="object"){s=l;break}else c&&typeof l=="object"&&(s=void 0,r={...r,...l})}return s!==void 0?s:Object.keys(r).length>0?r:t||this.options.notFoundHandler(e)}__getFlat(e,t){const n=this.flattened[e];return n!==void 0?n:t||this.options.notFoundHandler(e)}__inspect(e){const t={key:e,resolved:{value:void 0,source:""},layers:[]},n=p(e)?d(e):[e],i=Array.from(this.layers.keys()).reverse();if(n.length<1)return{key:e,resolved:{value:void 0,source:""},layers:i.map(r=>({layer:r,value:void 0,isPresent:!1,isActive:!1}))};if(n.length==1){let r=!1;for(const s of i){const o=this.layers.get(s),l=!!(o&&e in o),c=l?o?.[e]:void 0,f=l?!r:!1;t.layers.push({layer:s,value:l?c:void 0,isPresent:l,isActive:f}),f&&!r&&(t.resolved.value=c,t.resolved.source=s,r=!0)}}if(n.length>1)for(const r of i){let s=this.layers.get(r);if(!s)continue;let o=!0;for(const c of n)if(s&&typeof s=="object"&&c in s)s=s[c];else{o=!1;break}o||(s=void 0);const l=o&&s!==void 0;t.layers.push({layer:r,value:l?s:void 0,isPresent:o,isActive:l&&t.resolved.value===void 0}),l&&t.resolved.value===void 0&&(t.resolved.value=s,t.resolved.source=r)}return t}}exports.LayeredConfig=u;
